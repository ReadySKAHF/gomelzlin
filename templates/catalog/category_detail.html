{% extends 'base.html' %}
{% load static %}
{% load russian_utils %}

{% block title %}{{ category.name }} - –û–ê–û "–ì–ó–õ–∏–ù"{% endblock %}

{% block extra_js %}
<script src="{% static 'js/wishlist.js' %}"></script>
{% endblock %}

{% block content %}
<!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è JavaScript -->
{% if user.is_authenticated %}
<div data-user-authenticated="true" style="display: none;"></div>
{% endif %}

<div class="category-page">
    <!-- –ö—Ä–∞—Å–∏–≤—ã–π —Ö–µ–¥–µ—Ä —Å breadcrumbs -->
    <div class="category-header" style="
        background: linear-gradient(135deg, #cb413b 0%, #a0342e 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 3rem;
    ">
        <div class="container">
            <nav aria-label="breadcrumb" style="margin-bottom: 1rem;">
                <ol class="breadcrumb" style="
                    background: none;
                    padding: 0;
                    margin: 0;
                    display: flex;
                    list-style: none;
                    gap: 0.5rem;
                    align-items: center;
                ">
                    <li class="breadcrumb-item">
                        <a href="{% url 'core:home' %}" style="color: rgba(255,255,255,0.8); text-decoration: none;">
                            –ì–ª–∞–≤–Ω–∞—è
                        </a>
                    </li>
                    <li style="color: rgba(255,255,255,0.6);">></li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'catalog:product_list' %}" style="color: rgba(255,255,255,0.8); text-decoration: none;">
                            –ö–∞—Ç–∞–ª–æ–≥
                        </a>
                    </li>
                    <li style="color: rgba(255,255,255,0.6);">></li>
                    <li class="breadcrumb-item active" style="color: white; font-weight: 500;">
                        {{ category.name }}
                    </li>
                </ol>
            </nav>
            
            <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">{{ category.name }}</h1>
            {% if category.description %}
                <p style="font-size: 1.2rem; opacity: 0.9; max-width: 600px;">{{ category.description }}</p>
            {% else %}
                <p style="font-size: 1.2rem; opacity: 0.9;">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è {{ category.name }}</p>
            {% endif %}
        </div>
    </div>

    <div class="container">
        {% if error %}
            <div style="
                background: #f8d7da;
                color: #721c24;
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 2rem;
                text-align: center;
            ">
                {{ error }}
            </div>
        {% else %}
            {% if has_subcategories %}
                <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="subcategories-section" style="margin-bottom: 4rem;">
                    <h2 style="
                        color: #cb413b; 
                        font-size: 1.8rem; 
                        font-weight: 700; 
                        margin-bottom: 2rem; 
                        text-align: center;
                    ">
                        –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    </h2>
                    
                    <div style="
                        display: grid; 
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                        gap: 2rem;
                    ">
                        {% for subcat_data in subcategories_with_counts %}
                            <a href="{{ subcat_data.category.get_absolute_url }}" style="
                                text-decoration: none; 
                                color: inherit; 
                                display: block;
                            ">
                                <div style="
                                    background: white; 
                                    border-radius: 15px; 
                                    box-shadow: 0 5px 25px rgba(203, 65, 59, 0.15); 
                                    padding: 2rem; 
                                    transition: all 0.3s ease; 
                                    height: 100%;
                                    border: 1px solid #f0f0f0;
                                "
                                onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 15px 40px rgba(203, 65, 59, 0.25)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 25px rgba(203, 65, 59, 0.15)'">
                                    
                                    <div style="
                                        width: 60px; 
                                        height: 60px; 
                                        background: linear-gradient(135deg, #cb413b 0%, #a0342e 100%); 
                                        border-radius: 12px; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center; 
                                        font-size: 1.8rem; 
                                        margin-bottom: 1.5rem;
                                        color: white;
                                    ">
                                        üì¶
                                    </div>
                                    
                                    <h3 style="
                                        font-size: 1.3rem; 
                                        font-weight: 600; 
                                        color: #333; 
                                        margin-bottom: 1rem;
                                    ">
                                        {{ subcat_data.category.name }}
                                    </h3>
                                    
                                    <p style="
                                        color: #6c757d; 
                                        margin-bottom: 1.5rem; 
                                        line-height: 1.5;
                                    ">
                                        {% if subcat_data.category.description %}
                                            {{ subcat_data.category.description|truncatewords:20 }}
                                        {% else %}
                                            –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {{ subcat_data.category.name }}
                                        {% endif %}
                                    </p>
                                    
                                    <div style="
                                        display: flex; 
                                        justify-content: space-between; 
                                        align-items: center;
                                    ">
                                        <span style="
                                            background: linear-gradient(135deg, #cb413b 0%, #a0342e 100%);
                                            color: white;
                                            padding: 0.5rem 1rem;
                                            border-radius: 20px;
                                            font-size: 0.9rem;
                                            font-weight: 600;
                                        ">
                                            {{ subcat_data.product_count|count_with_word:"—Ç–æ–≤–∞—Ä,—Ç–æ–≤–∞—Ä–∞,—Ç–æ–≤–∞—Ä–æ–≤" }}
                                        </span>
                                        
                                        <span style="
                                            color: #cb413b; 
                                            font-size: 1.5rem; 
                                            font-weight: bold;
                                        ">‚Üí</span>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if products %}
                <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="products-section">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º –≤–∏–¥–æ–≤ -->
                    <div style="
                        display: flex; 
                        justify-content: space-between; 
                        align-items: center; 
                        margin-bottom: 2rem;
                        flex-wrap: wrap;
                        gap: 1rem;
                    ">
                        <h2 style="
                            color: #cb413b; 
                            font-size: 1.8rem; 
                            font-weight: 700; 
                            margin: 0;
                        ">
                            {% if has_subcategories %}
                                –¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            {% else %}
                                –¢–æ–≤–∞—Ä—ã
                            {% endif %}
                        </h2>
                        
                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                        <div class="view-toggle" style="
                            display: flex; 
                            gap: 0.5rem;
                            background: #f8f9fa;
                            padding: 0.25rem;
                            border-radius: 8px;
                            border: 1px solid #e9ecef;
                        ">
                            <a href="?view=grid" class="view-btn grid-btn" style="
                                padding: 0.5rem 1rem;
                                border-radius: 6px;
                                text-decoration: none;
                                font-size: 0.9rem;
                                font-weight: 600;
                                transition: all 0.2s ease;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                                {% if view_type == 'grid' %}
                                    background: #cb413b;
                                    color: white;
                                    box-shadow: 0 2px 4px rgba(203, 65, 59, 0.3);
                                {% else %}
                                    background: transparent;
                                    color: #6c757d;
                                {% endif %}
                            "
                            onmouseover="if (!this.classList.contains('active')) { this.style.backgroundColor='#e9ecef'; }"
                            onmouseout="if (!this.classList.contains('active')) { this.style.backgroundColor='transparent'; }"
                            >
                                <span style="font-size: 1rem;">‚äû</span>
                                –ü–ª–∏—Ç–∫–∞
                            </a>
                            
                            <a href="?view=list" class="view-btn list-btn" style="
                                padding: 0.5rem 1rem;
                                border-radius: 6px;
                                text-decoration: none;
                                font-size: 0.9rem;
                                font-weight: 600;
                                transition: all 0.2s ease;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                                {% if view_type == 'list' %}
                                    background: #cb413b;
                                    color: white;
                                    box-shadow: 0 2px 4px rgba(203, 65, 59, 0.3);
                                {% else %}
                                    background: transparent;
                                    color: #6c757d;
                                {% endif %}
                            "
                            onmouseover="if (!this.classList.contains('active')) { this.style.backgroundColor='#e9ecef'; }"
                            onmouseout="if (!this.classList.contains('active')) { this.style.backgroundColor='transparent'; }"
                            >
                                <span style="font-size: 1rem;">‚ò∞</span>
                                –°–ø–∏—Å–æ–∫
                            </a>
                        </div>
                    </div>

                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ -->
                    {% if view_type == 'grid' %}
                        <!-- –ü–õ–ò–¢–û–ß–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï -->
                        <div class="products-grid" style="
                            display: grid; 
                            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                            gap: 2rem;
                        ">
                            {% for product in products %}
                                <div class="product-card" style="
                                    background: white;
                                    border-radius: 15px;
                                    box-shadow: 0 5px 25px rgba(203, 65, 59, 0.15);
                                    overflow: hidden;
                                    transition: all 0.3s ease;
                                    border: 1px solid #f0f0f0;
                                    position: relative;
                                "
                                onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 15px 40px rgba(203, 65, 59, 0.25)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 25px rgba(203, 65, 59, 0.15)'">
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                                    <button class="wishlist-btn" 
                                            data-product-id="{{ product.id }}"
                                            data-product-name="{{ product.name }}"
                                            title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
                                            style="
                                        position: absolute;
                                        top: 1rem;
                                        right: 1rem;
                                        background: rgba(255, 255, 255, 0.9);
                                        border: none;
                                        border-radius: 50%;
                                        width: 40px;
                                        height: 40px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        z-index: 2;
                                        transition: all 0.2s ease;
                                        font-size: 1.2rem;
                                    "
                                    onmouseover="this.style.background='#cb413b'; this.style.color='white'"
                                    onmouseout="this.style.background='rgba(255, 255, 255, 0.9)'; this.style.color='#333'"
                                    >
                                        <span class="heart-icon">‚ô°</span>
                                    </button>
                                    
                                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
                                    <div class="product-image" style="
                                        height: 250px;
                                        background: #f8f9fa;
                                        position: relative;
                                        overflow: hidden;
                                    ">
                                        {% if product.image %}
                                            <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                                 style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                height: 100%;
                                                color: #cb413b;
                                                font-size: 4rem;
                                            ">
                                                {% if '–∂–∞—Ç–∫–∞' in product.name|lower %}
                                                    üåæ
                                                {% elif '–∫–æ–º–±–∞–π–Ω' in product.name|lower %}
                                                    üöú
                                                {% elif '–±–æ–ª—Ç' in product.name|lower or '–≥–∞–π–∫–∞' in product.name|lower %}
                                                    üî©
                                                {% elif '–±—É–Ω–∫–µ—Ä' in product.name|lower %}
                                                    üì¶
                                                {% else %}
                                                    üè≠
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        {% if product.is_featured %}
                                        <span style="
                                            position: absolute;
                                            top: 1rem;
                                            left: 1rem;
                                            background: #28a745;
                                            color: white;
                                            padding: 0.3rem 0.8rem;
                                            border-radius: 20px;
                                            font-size: 0.8rem;
                                            font-weight: 600;
                                        ">
                                            ‚≠ê –•–∏—Ç
                                        </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                                    <div style="padding: 1.5rem;">
                                        <h3 style="
                                            font-size: 1.2rem;
                                            font-weight: 600;
                                            color: #333;
                                            margin-bottom: 0.5rem;
                                            line-height: 1.3;
                                            min-height: 2.6rem;
                                        ">
                                            <a href="{{ product.get_absolute_url }}" style="
                                                color: inherit;
                                                text-decoration: none;
                                            "
                                            onmouseover="this.style.color='#cb413b'"
                                            onmouseout="this.style.color='#333'"
                                            >
                                                {{ product.name|truncatechars:60 }}
                                            </a>
                                        </h3>
                                        
                                        <p style="
                                            color: #6c757d;
                                            font-size: 0.9rem;
                                            margin-bottom: 1rem;
                                        ">
                                            –ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}
                                        </p>
                                        
                                        {% if product.short_description %}
                                        <p style="
                                            color: #6c757d;
                                            font-size: 0.9rem;
                                            margin-bottom: 1rem;
                                            line-height: 1.4;
                                            min-height: 2.8rem;
                                        ">
                                            {{ product.short_description|truncatewords:15 }}
                                        </p>
                                        {% endif %}
                                        
                                        <!-- –¶–µ–Ω–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
                                        <div style="
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            margin-top: auto;
                                            padding-top: 1rem;
                                            border-top: 1px solid #f0f0f0;
                                        ">
                                            {% if product.price %}
                                            <div style="
                                                font-size: 1.3rem;
                                                font-weight: 700;
                                                color: #cb413b;
                                            ">
                                                {{ product.price }} BYN
                                            </div>
                                            {% else %}
                                            <div style="
                                                font-size: 1rem;
                                                font-weight: 600;
                                                color: #6c757d;
                                            ">
                                                –¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É
                                            </div>
                                            {% endif %}
                                            
                                            <button class="add-to-cart-btn" style="
                                                background: linear-gradient(135deg, #cb413b 0%, #a0342e 100%);
                                                color: white;
                                                border: none;
                                                padding: 0.6rem 1.2rem;
                                                border-radius: 8px;
                                                font-size: 0.9rem;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                                display: flex;
                                                align-items: center;
                                                gap: 0.5rem;
                                            "
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(203, 65, 59, 0.4)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                            onclick="addToCart({{ product.id }})"
                                            >
                                                üõí –í –∫–æ—Ä–∑–∏–Ω—É
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    
                    {% else %}
                        <!-- –°–ü–ò–°–û–ß–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï -->
                        <div class="products-list" style="
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                        ">
                            {% for product in products %}
                                <div class="product-list-item" style="
                                    background: white;
                                    border-radius: 12px;
                                    box-shadow: 0 3px 15px rgba(203, 65, 59, 0.1);
                                    padding: 1.5rem;
                                    display: flex;
                                    gap: 1.5rem;
                                    align-items: center;
                                    transition: all 0.3s ease;
                                    border: 1px solid #f0f0f0;
                                    position: relative;
                                "
                                onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 8px 25px rgba(203, 65, 59, 0.2)'"
                                onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 3px 15px rgba(203, 65, 59, 0.1)'">
                                    
                                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                                    <div class="product-list-image" style="
                                        width: 120px;
                                        height: 120px;
                                        border-radius: 8px;
                                        overflow: hidden;
                                        flex-shrink: 0;
                                        background: #f8f9fa;
                                    ">
                                        {% if product.image %}
                                            <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                                 style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                height: 100%;
                                                color: #cb413b;
                                                font-size: 2.5rem;
                                            ">
                                                {% if '–∂–∞—Ç–∫–∞' in product.name|lower %}
                                                    üåæ
                                                {% elif '–∫–æ–º–±–∞–π–Ω' in product.name|lower %}
                                                    üöú
                                                {% elif '–±–æ–ª—Ç' in product.name|lower or '–≥–∞–π–∫–∞' in product.name|lower %}
                                                    üî©
                                                {% elif '–±—É–Ω–∫–µ—Ä' in product.name|lower %}
                                                    üì¶
                                                {% else %}
                                                    üè≠
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                    <div class="product-list-content" style="
                                        flex: 1;
                                        min-width: 0;
                                    ">
                                        <h3 style="
                                            font-size: 1.3rem;
                                            font-weight: 600;
                                            color: #333;
                                            margin-bottom: 0.5rem;
                                        ">
                                            <a href="{{ product.get_absolute_url }}" style="
                                                color: inherit;
                                                text-decoration: none;
                                            "
                                            onmouseover="this.style.color='#cb413b'"
                                            onmouseout="this.style.color='#333'"
                                            >
                                                {{ product.name }}
                                            </a>
                                        </h3>
                                        
                                        <div style="
                                            display: flex;
                                            gap: 1rem;
                                            margin-bottom: 0.5rem;
                                            flex-wrap: wrap;
                                        ">
                                            <span style="
                                                color: #6c757d;
                                                font-size: 0.9rem;
                                            ">
                                                –ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}
                                            </span>
                                            
                                            {% if product.is_featured %}
                                            <span style="
                                                background: #28a745;
                                                color: white;
                                                padding: 0.2rem 0.6rem;
                                                border-radius: 12px;
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                            ">
                                                ‚≠ê –•–∏—Ç
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if product.short_description %}
                                        <p style="
                                            color: #6c757d;
                                            font-size: 0.95rem;
                                            line-height: 1.4;
                                            margin-bottom: 1rem;
                                        ">
                                            {{ product.short_description|truncatewords:20 }}
                                        </p>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- –¶–µ–Ω–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
                                    <div class="product-list-actions" style="
                                        display: flex;
                                        flex-direction: column;
                                        align-items: flex-end;
                                        gap: 1rem;
                                        min-width: 180px;
                                    ">
                                        {% if product.price %}
                                        <div style="
                                            font-size: 1.4rem;
                                            font-weight: 700;
                                            color: #cb413b;
                                            text-align: right;
                                        ">
                                            {{ product.price }} BYN
                                        </div>
                                        {% else %}
                                        <div style="
                                            font-size: 1.1rem;
                                            font-weight: 600;
                                            color: #6c757d;
                                            text-align: right;
                                        ">
                                            –¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É
                                        </div>
                                        {% endif %}
                                        
                                        <div style="
                                            display: flex;
                                            gap: 0.5rem;
                                        ">
                                            <button class="wishlist-btn" 
                                                    data-product-id="{{ product.id }}"
                                                    data-product-name="{{ product.name }}"
                                                    title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
                                                    style="
                                                background: #f8f9fa;
                                                border: 1px solid #e9ecef;
                                                border-radius: 8px;
                                                width: 40px;
                                                height: 40px;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                                font-size: 1.1rem;
                                            "
                                            onmouseover="this.style.background='#cb413b'; this.style.borderColor='#cb413b'; this.style.color='white'"
                                            onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e9ecef'; this.style.color='#333'"
                                            >
                                                <span class="heart-icon">‚ô°</span>
                                            </button>
                                            
                                            <button class="add-to-cart-btn-list" style="
                                                background: linear-gradient(135deg, #cb413b 0%, #a0342e 100%);
                                                color: white;
                                                border: none;
                                                padding: 0.6rem 1.2rem;
                                                border-radius: 8px;
                                                font-size: 0.9rem;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                                display: flex;
                                                align-items: center;
                                                gap: 0.5rem;
                                            "
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(203, 65, 59, 0.4)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                            onclick="addToCart({{ product.id }})"
                                            >
                                                üõí –í –∫–æ—Ä–∑–∏–Ω—É
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            {% if not has_subcategories and not products %}
                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                <div style="
                    text-align: center;
                    padding: 4rem 2rem;
                    color: #6c757d;
                ">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üì¶</div>
                    <h3 style="margin-bottom: 1rem; color: #cb413b;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</p>
                    <a href="{% url 'catalog:product_list' %}" style="
                        display: inline-block;
                        margin-top: 1rem;
                        background: linear-gradient(135deg, #cb413b 0%, #a0342e 100%);
                        color: white;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        text-decoration: none;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'"
                    >
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É
                    </a>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>

<!-- JavaScript -->
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WishlistManager, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (typeof WishlistManager !== 'undefined') {
        window.wishlistManager = new WishlistManager();
    }
    
    // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    setTimeout(() => {
        const wishlistButtons = document.querySelectorAll('.wishlist-btn');
        wishlistButtons.forEach(btn => {
            const productId = btn.getAttribute('data-product-id');
            if (productId) {
                if (typeof window.wishlistManager !== 'undefined') {
                    window.wishlistManager.checkWishlistStatus(productId);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                if (!btn.hasAttribute('data-wishlist-initialized')) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (typeof window.wishlistManager !== 'undefined') {
                            const productName = this.getAttribute('data-product-name') || '—Ç–æ–≤–∞—Ä';
                            window.wishlistManager.toggleWishlist(productId, productName);
                        } else {
                            // Fallback –µ—Å–ª–∏ WishlistManager –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                            toggleWishlistFallback(productId, this.getAttribute('data-product-name'));
                        }
                    });
                    btn.setAttribute('data-wishlist-initialized', 'true');
                }
            }
        });
    }, 100);
});

// Fallback —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function toggleWishlistFallback(productId, productName) {
    const userAuthElement = document.querySelector('[data-user-authenticated]');
    const isAuthenticated = userAuthElement && userAuthElement.getAttribute('data-user-authenticated') === 'true';
    
    if (!isAuthenticated) {
        showNotification('–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'warning');
        return;
    }
    
    fetch('/cart/wishlist/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: `product_id=${productId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || `"${productName}" –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º!`, 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–Ω–æ–ø–∫–∏
            const buttons = document.querySelectorAll(`[data-product-id="${productId}"]`);
            buttons.forEach(btn => {
                const heartIcon = btn.querySelector('.heart-icon');
                if (heartIcon) {
                    if (data.in_wishlist) {
                        heartIcon.textContent = '‚ô•';
                        heartIcon.style.color = '#e74c3c';
                        btn.title = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ';
                    } else {
                        heartIcon.textContent = '‚ô°';
                        heartIcon.style.color = '#ccc';
                        btn.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
                    }
                }
            });
        } else {
            showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
function addToCart(productId) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userAuthElement = document.querySelector('[data-user-authenticated]');
    const isAuthenticated = userAuthElement && userAuthElement.getAttribute('data-user-authenticated') === 'true';
    
    if (!isAuthenticated) {
        showNotification('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'warning');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ –î–æ–±–∞–≤–ª—è–µ–º...';
    button.disabled = true;
    
    // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
    fetch('/cart/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: `product_id=${productId}&quantity=1`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –≤ —à–∞–ø–∫–µ
            updateCartCounter(data.cart_count);
        } else {
            showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let container = document.getElementById('notifications');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notifications';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 300px;
        `;
        document.body.appendChild(container);
    }
    
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.style.cssText = `
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
        cursor: pointer;
    `;
    
    notification.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    container.appendChild(notification);
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ
    notification.addEventListener('click', () => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartCounter(count) {
    const counter = document.querySelector('.cart-counter');
    if (counter) {
        counter.textContent = count;
        counter.style.display = count > 0 ? 'inline-block' : 'none';
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ –≤ localStorage
document.addEventListener('DOMContentLoaded', function() {
    const currentView = new URLSearchParams(window.location.search).get('view') || 'grid';
    localStorage.setItem('catalogView', currentView);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    const gridBtn = document.querySelector('.grid-btn');
    const listBtn = document.querySelector('.list-btn');
    
    if (currentView === 'grid' && gridBtn) {
        gridBtn.classList.add('active');
    } else if (currentView === 'list' && listBtn) {
        listBtn.classList.add('active');
    }
});
</script>

<style>
/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .products-grid {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
    }
    
    .product-list-item {
        flex-direction: column !important;
        align-items: flex-start !important;
        text-align: left !important;
    }
    
    .product-list-image {
        width: 100% !important;
        max-width: 200px !important;
        align-self: center !important;
    }
    
    .product-list-actions {
        width: 100% !important;
        min-width: unset !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .view-toggle {
        width: 100% !important;
        justify-content: center !important;
    }
    
    .category-header h1 {
        font-size: 2rem !important;
    }
    
    .category-header p {
        font-size: 1rem !important;
    }
}

@media (max-width: 480px) {
    .container {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
    
    .product-card,
    .product-list-item {
        margin: 0 -0.5rem !important;
    }
    
    .product-list-actions {
        flex-direction: column !important;
        gap: 0.5rem !important;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.product-card,
.product-list-item {
    animation: fadeIn 0.3s ease-out;
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #cb413b;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a0342e;
}
</style>
{% endblock %}