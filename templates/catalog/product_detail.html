{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-red: #cb413b;
    --secondary-gray: #808080;
    --light-gray: #f8f9fa;
    --dark-gray: #333;
    --success-green: #28a745;
    --warning-orange: #fd7e14;
    --border-color: #e9ecef;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --radius: 8px;
}

.product-hero {
    background: linear-gradient(135deg, var(--primary-red), #e74c3c);
    color: white;
    padding: 2rem 0;
    margin-bottom: 3rem;
}

.product-gallery {
    position: relative;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.main-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
    cursor: zoom-in;
}

.image-placeholder {
    width: 100%;
    height: 400px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    color: var(--secondary-gray);
}

.thumbnail-gallery {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
}

.thumbnail {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.thumbnail:hover,
.thumbnail.active {
    opacity: 1;
    border-color: var(--primary-red);
    transform: scale(1.05);
}

.product-info {
    background: white;
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.product-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 1rem;
    line-height: 1.3;
}

.product-article {
    color: var(--secondary-gray);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    padding: 0.5rem 1rem;
    background: var(--light-gray);
    border-radius: 20px;
    display: inline-block;
}

.product-price {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-red);
    margin-bottom: 1.5rem;
}

.old-price {
    font-size: 1.5rem;
    color: var(--secondary-gray);
    text-decoration: line-through;
    margin-left: 1rem;
}

.stock-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    margin-bottom: 2rem;
    display: inline-block;
}

.in-stock {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success-green);
}

.low-stock {
    background: rgba(253, 126, 20, 0.1);
    color: var(--warning-orange);
}

.out-of-stock {
    background: rgba(203, 65, 59, 0.1);
    color: var(--primary-red);
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

.quantity-label {
    font-weight: 600;
    color: var(--dark-gray);
}

.quantity-input {
    display: flex;
    align-items: center;
    border: 2px solid var(--border-color);
    border-radius: var(--radius);
    overflow: hidden;
}

.quantity-btn {
    background: var(--light-gray);
    border: none;
    width: 40px;
    height: 40px;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.quantity-btn:hover {
    background: var(--primary-red);
    color: white;
}

.quantity-field {
    border: none;
    width: 80px;
    height: 40px;
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
}

.add-to-cart-btn {
    background: var(--primary-red);
    color: white;
    border: none;
    padding: 1rem 3rem;
    font-size: 1.2rem;
    font-weight: 600;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
}

.add-to-cart-btn:hover {
    background: #b8362f;
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(203, 65, 59, 0.3);
}

.add-to-cart-btn:disabled {
    background: var(--secondary-gray);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.product-tabs {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.tab-nav {
    display: flex;
    border-bottom: 1px solid var(--border-color);
}

.tab-button {
    background: none;
    border: none;
    padding: 1rem 2rem;
    font-weight: 600;
    color: var(--secondary-gray);
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.tab-button.active {
    color: var(--primary-red);
    border-bottom-color: var(--primary-red);
}

.tab-content {
    padding: 2rem;
    display: none;
}

.tab-content.active {
    display: block;
}

.similar-products {
    background: white;
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow);
}

.similar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.similar-product-card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    overflow: hidden;
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
}

.similar-product-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
    text-decoration: none;
    color: inherit;
}

.similar-product-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.similar-product-info {
    padding: 1rem;
}

.similar-product-name {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.similar-product-price {
    color: var(--primary-red);
    font-weight: 700;
}

.loading-spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.loading-spinner.active {
    display: block;
    animation: spin 1s linear infinite;
}

@media (max-width: 768px) {
    .product-title {
        font-size: 1.5rem;
    }
    
    .product-price {
        font-size: 2rem;
    }
    
    .quantity-selector {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .tab-nav {
        flex-direction: column;
    }
    
    .similar-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Hero —Å–µ–∫—Ü–∏—è -->
<div class="product-hero">
    <div class="container">
        <nav aria-label="breadcrumb" style="margin-bottom: 1rem;">
            <ol class="breadcrumb" style="background: transparent; margin-bottom: 0;">
                <li class="breadcrumb-item">
                    <a href="{% url 'core:home' %}" style="color: rgba(255,255,255,0.8);">–ì–ª–∞–≤–Ω–∞—è</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'catalog:product_list' %}" style="color: rgba(255,255,255,0.8);">–ö–∞—Ç–∞–ª–æ–≥</a>
                </li>
                {% if product.category %}
                <li class="breadcrumb-item">
                    <a href="{{ product.category.get_absolute_url }}" style="color: rgba(255,255,255,0.8);">{{ product.category.name }}</a>
                </li>
                {% endif %}
                <li class="breadcrumb-item active" style="color: white;">{{ product.name }}</li>
            </ol>
        </nav>
        
        <h1 class="product-title" style="color: white; margin-bottom: 0;">{{ product.name }}</h1>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="col-lg-6">
            <div class="product-gallery">
                {% if product_images and product_images.first %}
                    <img src="{{ product_images.first.image.url }}" alt="{{ product.name }}" class="main-image" id="mainImage">
                    
                    {% if product_images.count > 1 %}
                    <div class="thumbnail-gallery">
                        {% for image in product_images %}
                        <img src="{{ image.image.url }}" alt="{{ product.name }}" 
                             class="thumbnail {% if forloop.first %}active{% endif %}"
                             onclick="changeMainImage('{{ image.image.url }}', this)">
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <div class="image-placeholder">
                        üì¶
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        <div class="col-lg-6">
            <div class="product-info">
                {% if product.article %}
                <div class="product-article">
                    –ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}
                </div>
                {% endif %}

                <div class="product-price">
                    {% if product.old_price %}
                        <span class="old-price">{{ product.old_price }} BYN</span>
                    {% endif %}
                    {{ product.price }} BYN
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è -->
                {% if product.stock_quantity > 0 %}
                    {% if product.stock_quantity <= product.min_stock_level %}
                        <div class="stock-status low-stock">
                            ‚ö†Ô∏è –ú–∞–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ ({{ product.stock_quantity }} {{ product.get_unit_display }})
                        </div>
                    {% else %}
                        <div class="stock-status in-stock">
                            ‚úÖ –í –Ω–∞–ª–∏—á–∏–∏ ({{ product.stock_quantity }} {{ product.get_unit_display }})
                        </div>
                    {% endif %}
                {% else %}
                    <div class="stock-status out-of-stock">
                        ‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                    </div>
                {% endif %}

                <!-- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
                {% if product.short_description %}
                <div style="margin-bottom: 2rem; color: var(--dark-gray); line-height: 1.6;">
                    {{ product.short_description }}
                </div>
                {% endif %}

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
                <form id="addToCartForm" style="margin-bottom: 2rem;">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    
                    <div class="quantity-selector">
                        <label class="quantity-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                        <div class="quantity-input">
                            <button type="button" class="quantity-btn" onclick="changeQuantity(-1)">‚àí</button>
                            <input type="number" name="quantity" value="1" min="1" 
                                   max="{{ product.stock_quantity }}" class="quantity-field" id="quantityField">
                            <button type="button" class="quantity-btn" onclick="changeQuantity(1)">+</button>
                        </div>
                    </div>

                    <button type="submit" class="add-to-cart-btn" id="addToCartBtn" 
                            {% if product.stock_quantity <= 0 %}disabled{% endif %}>
                        <span class="btn-text">
                            {% if product.stock_quantity > 0 %}
                                üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                            {% else %}
                                –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            {% endif %}
                        </span>
                        <div class="loading-spinner">‚è≥</div>
                    </button>
                </form>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                {% if product.weight or product.dimensions or product.material %}
                <div class="product-specs" style="border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                    <h6 style="color: var(--dark-gray); margin-bottom: 1rem;">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</h6>
                    {% if product.weight %}
                    <div style="margin-bottom: 0.5rem;">
                        <strong>–í–µ—Å:</strong> {{ product.weight }} –∫–≥
                    </div>
                    {% endif %}
                    {% if product.dimensions %}
                    <div style="margin-bottom: 0.5rem;">
                        <strong>–†–∞–∑–º–µ—Ä—ã:</strong> {{ product.dimensions }}
                    </div>
                    {% endif %}
                    {% if product.material %}
                    <div style="margin-bottom: 0.5rem;">
                        <strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> {{ product.material }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –¢–∞–±—ã —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
    <div class="product-tabs">
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('description')">–û–ø–∏—Å–∞–Ω–∏–µ</button>
            {% if product.specifications %}
            <button class="tab-button" onclick="switchTab('specifications')">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</button>
            {% endif %}
        </div>

        <div class="tab-content active" id="description">
            {% if product.description %}
                {{ product.description|linebreaks }}
            {% else %}
                <p>–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</p>
            {% endif %}
        </div>

        {% if product.specifications %}
        <div class="tab-content" id="specifications">
            {{ product.specifications|linebreaks }}
        </div>
        {% endif %}
    </div>

    <!-- –ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã -->
    {% if similar_products %}
    <div class="similar-products">
        <h3 style="color: var(--dark-gray); margin-bottom: 1rem;">–ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã</h3>
        <div class="similar-grid">
            {% for similar in similar_products %}
            <a href="{% url 'catalog:product_detail' slug=similar.slug %}" class="similar-product-card">
                {% if similar.image %}
                    <img src="{{ similar.image.url }}" alt="{{ similar.name }}" class="similar-product-image">
                {% else %}
                    <div class="similar-product-image" style="background: var(--light-gray); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--secondary-gray);">
                        üì¶
                    </div>
                {% endif %}
                <div class="similar-product-info">
                    <div class="similar-product-name">{{ similar.name }}</div>
                    <div class="similar-product-price">{{ similar.price }} BYN</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notifications" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
{% endblock %}

{% block extra_js %}
<script>
// –°–º–µ–Ω–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function changeMainImage(imageSrc, thumbnail) {
    document.getElementById('mainImage').src = imageSrc;
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –º–∏–Ω–∏–∞—Ç—é—Ä
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –º–∏–Ω–∏–∞—Ç—é—Ä–µ
    thumbnail.classList.add('active');
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
function changeQuantity(delta) {
    const quantityField = document.getElementById('quantityField');
    const currentValue = parseInt(quantityField.value);
    const newValue = currentValue + delta;
    const maxValue = parseInt(quantityField.max);
    
    if (newValue >= 1 && newValue <= maxValue) {
        quantityField.value = newValue;
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
function switchTab(tabName) {
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.getElementById('notifications').appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
document.getElementById('addToCartForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('addToCartBtn');
    const btnText = btn.querySelector('.btn-text');
    const spinner = btn.querySelector('.loading-spinner');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    btn.disabled = true;
    btnText.style.opacity = '0.5';
    spinner.classList.add('active');
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('/cart/add/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            const cartCounter = document.querySelector('.cart-counter');
            if (cartCounter && data.cart_count) {
                cartCounter.textContent = data.cart_count;
                cartCounter.style.display = data.cart_count > 0 ? 'inline-block' : 'none';
            }
        } else {
            showNotification(`‚ùå ${data.message}`, 'danger');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É:', error);
        showNotification('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
    } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        btn.disabled = false;
        btnText.style.opacity = '1';
        spinner.classList.remove('active');
    }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
document.getElementById('quantityField').addEventListener('input', function() {
    const value = parseInt(this.value);
    const max = parseInt(this.max);
    
    if (value < 1) {
        this.value = 1;
    } else if (value > max) {
        this.value = max;
        showNotification(`‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${max}`, 'warning');
    }
});
</script>
{% endblock %}