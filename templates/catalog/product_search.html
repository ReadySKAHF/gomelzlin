{% extends 'base.html' %}

{% block title %}{{ title }} - –û–ê–û "–ì–ó–õ–∏–ù"{% endblock %}

{% block content %}
<div class="container" style="padding: 3rem 0;">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <div style="margin-bottom: 2rem; color: var(--secondary-gray);">
        <a href="{% url 'core:home' %}" style="color: var(--primary-red);">–ì–ª–∞–≤–Ω–∞—è</a> / 
        <a href="{% url 'catalog:product_list' %}" style="color: var(--primary-red);">–ö–∞—Ç–∞–ª–æ–≥</a> / 
        <span>–ü–æ–∏—Å–∫</span>
    </div>
    
    <h1>–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    
    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div style="background: white; border-radius: 10px; box-shadow: var(--shadow); padding: 2rem; margin-bottom: 2rem;">
        <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div style="flex: 1; min-width: 250px;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é</label>
                <input type="text" name="q" value="{{ query }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." 
                       style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-gray); border-radius: 5px;">
            </div>
            <div style="min-width: 200px;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select name="category" style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-gray); border-radius: 5px;">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem;">
                üîç –ü–æ–∏—Å–∫
            </button>
        </form>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    {% if query or selected_category %}
        <div style="margin-bottom: 2rem;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
            {% if query %}
                <p style="color: var(--secondary-gray);">–ü–æ –∑–∞–ø—Ä–æ—Å—É: <strong>"{{ query }}"</strong></p>
            {% endif %}
            {% if selected_category %}
                {% for category in categories %}
                    {% if category.id|stringformat:"s" == selected_category %}
                        <p style="color: var(--secondary-gray);">–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: <strong>{{ category.name }}</strong></p>
                    {% endif %}
                {% endfor %}
            {% endif %}
            <p style="color: var(--secondary-gray);">–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong>{{ products|length }}</strong></p>
        </div>
        
        {% if products %}
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem;">
                <button class="btn btn-outline btn-sm" onclick="toggleView('grid')" id="gridBtn">‚äû –ü–ª–∏—Ç–∫–∞</button>
                <button class="btn btn-outline btn-sm" onclick="toggleView('list')" id="listBtn">‚ò∞ –°–ø–∏—Å–æ–∫</button>
            </div>
            
            <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div id="productGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem;">
                {% for product in products %}
                <div class="product-card" style="background: white; border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; transition: transform 0.3s; cursor: pointer;" 
                     onclick="window.location.href='{{ product.get_absolute_url }}'">
                     
                    {% if product.images.exists %}
                        <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 200px; object-fit: cover;">
                    {% else %}
                        <div style="width: 100%; height: 200px; background: var(--light-gray); display: flex; align-items: center; justify-content: center; color: var(--secondary-gray);">
                            –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
                        </div>
                    {% endif %}
                    
                    <div style="padding: 1.5rem;">
                        <h3 style="color: var(--primary-red); margin-bottom: 0.5rem; font-size: 1.1rem;">{{ product.name }}</h3>
                        {% if product.article %}
                            <p style="color: var(--secondary-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">–ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}</p>
                        {% endif %}
                        <p style="color: var(--secondary-gray); font-size: 0.9rem; margin-bottom: 1rem;">{{ product.category.name }}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-red);">
                                    {{ product.price }} BYN
                                </div>
                                {% if product.old_price and product.old_price > product.price %}
                                    <div style="font-size: 0.9rem; color: var(--secondary-gray); text-decoration: line-through;">{{ product.old_price }} BYN</div>
                                {% endif %}
                            </div>
                            {% if user.is_authenticated %}
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addToCart({{ product.id }})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                            {% endif %}
                        </div>
                        
                        <!-- –°—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è -->
                        <div style="margin-top: 0.5rem;">
                            {% if product.is_in_stock %}
                                <span style="color: #28a745; font-size: 0.9rem;">‚úì –í –Ω–∞–ª–∏—á–∏–∏</span>
                            {% else %}
                                <span style="color: #dc3545; font-size: 0.9rem;">‚úó –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div id="productList" style="display: none;">
                {% for product in products %}
                <div class="product-item" style="display: flex; gap: 1.5rem; padding: 1.5rem; border-bottom: 1px solid var(--light-gray); align-items: center; cursor: pointer;" 
                     onclick="window.location.href='{{ product.get_absolute_url }}'">
                     
                    {% if product.images.exists %}
                        <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                    {% else %}
                        <div style="width: 100px; height: 100px; background: var(--light-gray); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--secondary-gray); font-size: 0.8rem;">
                            –§–æ—Ç–æ
                        </div>
                    {% endif %}
                    
                    <div style="flex: 1;">
                        <h3 style="color: var(--primary-red); margin-bottom: 0.5rem;">{{ product.name }}</h3>
                        {% if product.article %}
                            <p style="color: var(--secondary-gray); margin-bottom: 0.5rem;">–ê—Ä—Ç–∏–∫—É–ª: {{ product.article }}</p>
                        {% endif %}
                        <p style="color: var(--secondary-gray); margin-bottom: 0.5rem;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ product.category.name }}</p>
                        {% if product.short_description %}
                            <p style="color: var(--dark-gray);">{{ product.short_description|truncatewords:20 }}</p>
                        {% endif %}
                    </div>
                    
                    <div style="text-align: right;">
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary-red); margin-bottom: 0.5rem;">
                            {{ product.price }} BYN
                        </div>
                        {% if product.old_price and product.old_price > product.price %}
                            <div style="font-size: 0.9rem; color: var(--secondary-gray); text-decoration: line-through; margin-bottom: 0.5rem;">{{ product.old_price }} BYN</div>
                        {% endif %}
                        <div style="font-size: 0.9rem; color: {% if product.is_in_stock %}#28a745{% else %}#dc3545{% endif %};">
                            {% if product.is_in_stock %}–í –Ω–∞–ª–∏—á–∏–∏{% else %}–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏{% endif %}
                        </div>
                    </div>
                    
                    {% if user.is_authenticated %}
                        <button class="btn btn-primary" onclick="event.stopPropagation(); addToCart({{ product.id }})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if is_paginated %}
            <div style="display: flex; justify-content: center; margin-top: 3rem;">
                <div style="display: flex; gap: 0.5rem;">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" style="padding: 0.5rem 1rem; border: 1px solid var(--light-gray); background: white; border-radius: 5px; text-decoration: none; color: var(--dark-gray);">–ü–µ—Ä–≤–∞—è</a>
                        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" style="padding: 0.5rem 1rem; border: 1px solid var(--light-gray); background: white; border-radius: 5px; text-decoration: none; color: var(--dark-gray);">–ù–∞–∑–∞–¥</a>
                    {% endif %}
                    
                    <span style="padding: 0.5rem 1rem; border: 1px solid var(--primary-red); background: var(--primary-red); color: white; border-radius: 5px;">
                        {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                    </span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" style="padding: 0.5rem 1rem; border: 1px solid var(--light-gray); background: white; border-radius: 5px; text-decoration: none; color: var(--dark-gray);">–î–∞–ª–µ–µ</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" style="padding: 0.5rem 1rem; border: 1px solid var(--light-gray); background: white; border-radius: 5px; text-decoration: none; color: var(--dark-gray);">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
        {% else %}
            <!-- –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div style="text-align: center; padding: 3rem; color: var(--secondary-gray);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥</p>
                <a href="{% url 'catalog:product_list' %}" class="btn btn-primary" style="margin-top: 1rem;">
                    –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
                </a>
            </div>
        {% endif %}
    {% else %}
        <!-- –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div style="text-align: center; padding: 3rem; color: var(--secondary-gray);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
            <h3>–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <p>–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</p>
        </div>
    {% endif %}
</div>

<script>
function toggleView(viewType) {
    const gridView = document.getElementById('productGrid');
    const listView = document.getElementById('productList');
    const gridBtn = document.getElementById('gridBtn');
    const listBtn = document.getElementById('listBtn');
    
    if (viewType === 'grid') {
        gridView.style.display = 'grid';
        listView.style.display = 'none';
        gridBtn.classList.add('btn-primary');
        gridBtn.classList.remove('btn-outline');
        listBtn.classList.add('btn-outline');
        listBtn.classList.remove('btn-primary');
    } else {
        gridView.style.display = 'none';
        listView.style.display = 'block';
        listBtn.classList.add('btn-primary');
        listBtn.classList.remove('btn-outline');
        gridBtn.classList.add('btn-outline');
        gridBtn.classList.remove('btn-primary');
    }
}

function addToCart(productId) {
    {% if not user.is_authenticated %}
        alert('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
        window.location.href = '{% url "accounts:login" %}';
        return;
    {% endif %}
    
    fetch('{% url "orders:add_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `product_id=${productId}&quantity=1`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
        } else {
            alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∞ —Å–µ—Ç–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const gridBtn = document.getElementById('gridBtn');
    if (gridBtn) {
        gridBtn.classList.add('btn-primary');
        gridBtn.classList.remove('btn-outline');
    }
});
</script>

<style>
.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}