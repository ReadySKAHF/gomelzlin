{% extends 'base.html' %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ - –û–ê–û "–ì–ó–õ–∏–ù"{% endblock %}

{% block content %}
<div class="container" style="padding: 3rem 0;">
    <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>
    
    {% if cart_items %}
        <div style="background: white; border-radius: 10px; box-shadow: var(--shadow); margin: 2rem 0;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã -->
            <div style="display: grid; grid-template-columns: 80px 1fr 120px 120px 120px 80px; gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--light-gray); font-weight: bold; color: var(--dark-gray);">
                <div>–§–æ—Ç–æ</div>
                <div>–¢–æ–≤–∞—Ä</div>
                <div>–¶–µ–Ω–∞</div>
                <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <div>–°—É–º–º–∞</div>
                <div></div>
            </div>
            
            <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
            {% for item in cart_items %}
            <div style="display: grid; grid-template-columns: 80px 1fr 120px 120px 120px 80px; gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--light-gray); align-items: center;">
                <!-- –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ -->
                <div>
                    {% if item.product.main_image %}
                        <img src="{{ item.product.main_image.image.url }}" alt="{{ item.product.name }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">
                    {% else %}
                        <div style="width: 60px; height: 60px; background: var(--light-gray); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--secondary-gray);">–§–æ—Ç–æ</div>
                    {% endif %}
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                <div>
                    <h3 style="margin-bottom: 0.5rem;">
                        <a href="{{ item.product.get_absolute_url }}" style="color: var(--primary-red); text-decoration: none;">
                            {{ item.product.name }}
                        </a>
                    </h3>
                    <p style="color: var(--secondary-gray); font-size: 0.9rem;">–ê—Ä—Ç–∏–∫—É–ª: {{ item.product.article }}</p>
                </div>
                
                <!-- –¶–µ–Ω–∞ -->
                <div style="font-weight: bold;">{{ item.product.price }} BYN</div>
                
                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <button class="btn btn-outline btn-sm" onclick="updateQuantity({{ item.id }}, -1)">-</button>
                    <input type="number" value="{{ item.quantity }}" min="1" style="width: 60px; text-align: center; border: 1px solid var(--light-gray); border-radius: 3px; padding: 0.25rem;" onchange="updateQuantity({{ item.id }}, this.value, true)">
                    <button class="btn btn-outline btn-sm" onclick="updateQuantity({{ item.id }}, 1)">+</button>
                </div>
                
                <!-- –û–±—â–∞—è —Å—É–º–º–∞ -->
                <div style="font-weight: bold; color: var(--primary-red);" id="total-{{ item.id }}">{{ item.get_total_price }} BYN</div>
                
                <!-- –£–¥–∞–ª–∏—Ç—å -->
                <div>
                    <button class="btn btn-danger btn-sm" onclick="removeFromCart({{ item.id }})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
            </div>
            {% endfor %}
            
            <!-- –ò—Ç–æ–≥–æ -->
            <div style="padding: 1.5rem; background: var(--light-gray);">
                <div style="text-align: right;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong>{{ cart.items_count }}</strong>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">
                        –ò—Ç–æ–≥–æ: <strong id="cart-total">{{ cart.total_price }} BYN</strong>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <a href="{% url 'catalog:product_list' %}" class="btn btn-outline">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</a>
                    <a href="{% url 'orders:checkout' %}" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
                </div>
            </div>
        </div>
    {% else %}
        <div style="text-align: center; padding: 3rem; background: white; border-radius: 10px; box-shadow: var(--shadow);">
            <div style="font-size: 4rem; margin-bottom: 1rem; color: var(--secondary-gray);">üõí</div>
            <h2 style="color: var(--secondary-gray); margin-bottom: 1rem;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
            <p style="color: var(--secondary-gray); margin-bottom: 2rem;">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</p>
            <a href="{% url 'catalog:product_list' %}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
        </div>
    {% endif %}
</div>

<script>
function updateQuantity(itemId, change, absolute = false) {
    let url = '{% url "orders:update_cart" %}';
    let formData = new FormData();
    formData.append('item_id', itemId);
    
    if (absolute) {
        formData.append('quantity', change);
    } else {
        formData.append('change', change);
    }
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
        } else {
            alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

function removeFromCart(itemId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) return;
    
    let url = '{% url "orders:remove_from_cart" %}';
    let formData = new FormData();
    formData.append('item_id', itemId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
        } else {
            alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}
</script>
{% endblock %}