{% extends 'base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –û–ê–û "–ì–ó–õ–∏–ù"{% endblock %}

{% block extra_css %}
<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è checkout -->
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ */
fieldset {
    background: white;
    border-radius: 10px;
    box-shadow: var(--shadow);
    padding: 1.5rem;
}

legend {
    padding: 0 1rem;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-red);
    box-shadow: 0 0 0 3px rgba(203, 65, 59, 0.1);
}

.form-group {
    margin-bottom: 1rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
@media (max-width: 768px) {
    .container > div {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    fieldset {
        margin-bottom: 1rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding: 3rem 0;">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 3rem; margin-top: 2rem;">
        <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
        <div>
            <form method="post" id="checkoutForm">
                {% csrf_token %}
                
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è *</legend>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label for="customer_name" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–§–ò–û *</label>
                            <input type="text" id="customer_name" name="customer_name" required
                                   value="{{ user.get_full_name }}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <label for="customer_phone" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                            <input type="tel" id="customer_phone" name="customer_phone" required
                                   value="{{ user.phone }}"
                                   placeholder="+375 (XX) XXX-XX-XX"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="customer_email" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">Email *</label>
                        <input type="email" id="customer_email" name="customer_email" required
                               value="{{ user.email }}"
                               placeholder="your@email.com"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                </fieldset>
                
                {% if user.is_company %}
                <!-- –î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü) -->
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü)</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="company_name" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                        <input type="text" id="company_name" name="company_name"
                               value="{{ company_profile.company_name|default:'' }}"
                               placeholder="–û–û–û ¬´–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏¬ª"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label for="company_unp" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–£–ù–ü</label>
                            <input type="text" id="company_unp" name="company_unp"
                                   value="{{ company_profile.unp|default:'' }}"
                                   placeholder="123456789" maxlength="9"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div>
                            <!-- –ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="company_address" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                        <textarea id="company_address" name="company_address" rows="3"
                                  placeholder="–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical;">{{ company_profile.legal_address|default:'' }}</textarea>
                    </div>
                </fieldset>
                {% endif %}
                
                <!-- –î–æ—Å—Ç–∞–≤–∫–∞ -->
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–î–æ—Å—Ç–∞–≤–∫–∞ *</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="delivery_method" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        <select id="delivery_method" name="delivery_method" required onchange="toggleDeliveryAddress()"
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)</option>
                            <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É</option>
                            <option value="transport_company">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è</option>
                        </select>
                    </div>
                    
                    <div id="delivery_address_section" style="display: none;">
                        <!-- –í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –≤–≤–æ–¥ –Ω–æ–≤–æ–≥–æ -->
                        {% if delivery_addresses %}
                        <div style="margin-bottom: 1rem;">
                            <label for="saved_address_id" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <select id="saved_address_id" name="saved_address_id" onchange="toggleAddressInput()"
                                    style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                                {% if default_address %}
                                    <option value="{{ default_address.id }}" selected>{{ default_address.title }} - {{ default_address.get_short_address }}</option>
                                {% endif %}
                                {% for address in delivery_addresses %}
                                    {% if not address.is_default %}
                                    <option value="{{ address.id }}">{{ address.title }} - {{ address.get_short_address }}</option>
                                    {% endif %}
                                {% endfor %}
                                <option value="new">‚ûï –í–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å</option>
                            </select>
                        </div>
                        {% endif %}
                        
                        <div id="new_address_input" style="{% if delivery_addresses and default_address %}display: none;{% endif %}">
                            <label for="delivery_address" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ {% if not delivery_addresses %}*{% endif %}</label>
                            <textarea id="delivery_address" name="delivery_address" rows="3"
                                      placeholder="–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≥–æ—Ä–æ–¥–∞, —É–ª–∏—Ü—ã, –¥–æ–º–∞, –∫–≤–∞—Ä—Ç–∏—Ä—ã/–æ—Ñ–∏—Å–∞"
                                      style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            <small style="color: var(--secondary-gray);">
                                üí° –°–æ–≤–µ—Ç: –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –≤ <a href="{% url 'accounts:profile' %}#addresses" target="_blank" style="color: var(--primary-red);">–ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ</a> –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≤ –±—É–¥—É—â–µ–º
                            </small>
                        </div>
                    </div>
                </fieldset>
                
                <!-- –û–ø–ª–∞—Ç–∞ -->
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–û–ø–ª–∞—Ç–∞ *</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="payment_method" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã *</label>
                        <select id="payment_method" name="payment_method" required
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç</option>
                            <option value="bank_transfer">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option>
                            <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                            {% if user.is_company %}
                            <option value="invoice">–ü–æ —Å—á–µ—Ç—É (–¥–ª—è —é—Ä. –ª–∏—Ü)</option>
                            {% endif %}
                        </select>
                    </div>
                </fieldset>
                
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                <div style="margin-bottom: 2rem;">
                    <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                    <textarea id="notes" name="notes" rows="4"
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∫ –∑–∞–∫–∞–∑—É, –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ —Ç.–¥."
                              style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                    üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                </button>
            </form>
        </div>
        
        <!-- –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞ -->
        <div>
            <div style="position: sticky; top: 2rem;">
                <h2>–í–∞—à –∑–∞–∫–∞–∑</h2>
                <div style="background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem;">
                    {% for item in cart_items %}
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 1rem 0; border-bottom: 1px solid var(--light-gray);" 
                         data-item-price="{{ item.product.price }}" data-item-quantity="{{ item.quantity }}" data-item-total="{{ item.get_total_price }}">
                        <div style="flex: 1; margin-right: 1rem;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ item.product.name }}</div>
                            <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                {{ item.product.price }} BYN √ó {{ item.quantity }}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: var(--primary-red); white-space: nowrap;">
                            {{ item.get_total_price }} BYN
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div style="padding-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>–¢–æ–≤–∞—Ä—ã:</span>
                            <span id="subtotal_cost">{{ cart.total_price }} BYN</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                            <span id="delivery_cost">0.00 BYN</span>
                        </div>
                        <hr style="margin: 1rem 0; border: none; border-top: 2px solid var(--light-gray);">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: bold; color: var(--primary-red);">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span id="total_cost">{{ cart.total_price }} BYN</span>
                        </div>
                    </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid var(--primary-red);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-red);">üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: var(--secondary-gray);">
                        <li>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã SSL-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º</li>
                        <li>–ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º</li>
                        <li>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ */
fieldset {
    background: white;
    border-radius: 10px;
    box-shadow: var(--shadow);
    padding: 1.5rem;
}

legend {
    padding: 0 1rem;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-red);
    box-shadow: 0 0 0 3px rgba(203, 65, 59, 0.1);
}

.form-group {
    margin-bottom: 1rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
@media (max-width: 768px) {
    .container > div {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    fieldset {
        margin-bottom: 1rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
let cartSubtotal = {{ cart.total_price|default:0 }};
let deliveryCost = 0;

// –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–±—É–¥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã CheckoutManager'–æ–º)
function getCartSubtotal() {
    return cartSubtotal;
}

function toggleDeliveryAddress() {
    console.log('Basic toggleDeliveryAddress called - CheckoutManager will override this');
}

function toggleAddressInput() {
    console.log('Basic toggleAddressInput called - CheckoutManager will override this');
}

function updateTotalCost() {
    console.log('Basic updateTotalCost called - CheckoutManager will override this');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, cart subtotal:', cartSubtotal);
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –∏ –µ—Å—Ç—å –∞–¥—Ä–µ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞
    {% if delivery_addresses and default_address %}
    const newAddressInput = document.getElementById('new_address_input');
    if (newAddressInput) {
        newAddressInput.style.display = 'none';
    }
    {% endif %}
    
    // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã (–±—É–¥–µ—Ç –¥–æ–ø–æ–ª–Ω–µ–Ω–∞ CheckoutManager'–æ–º)
    const form = document.getElementById('checkoutForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –±–æ–ª—å—à–µ 0
            const finalSubtotal = getCartSubtotal();
            if (finalSubtotal <= 0) {
                e.preventDefault();
                alert('–û—à–∏–±–∫–∞: —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ —Ä–∞–≤–Ω–∞ –Ω—É–ª—é. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
                return;
            }
        });
    }
    
    console.log('Basic checkout initialization complete');
});
</script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º CheckoutManager -->
<script src="{% static 'js/checkout_enhancements.js' %}"></script>
{% endblock %}