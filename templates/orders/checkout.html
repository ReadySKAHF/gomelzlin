{% extends 'base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –û–ê–û "–ì–ó–õ–∏–ù"{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-top: 2rem;">
        <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
        <div>
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑—á–∏–∫–µ</h2>
            <form method="post">
                {% csrf_token %}
                
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ *</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="customer_name" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–§–ò–û *</label>
                        <input type="text" id="customer_name" name="customer_name" required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –§–ò–û"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="customer_email" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">Email *</label>
                        <input type="email" id="customer_email" name="customer_email" 
                               value="{{ user.email }}" required
                               placeholder="example@domain.com"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="customer_phone" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="customer_phone" name="customer_phone" required
                               placeholder="+375 (XX) XXX-XX-XX"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                </fieldset>
                
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ (–¥–ª—è —é—Ä. –ª–∏—Ü)</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="company_name" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                        <input type="text" id="company_name" name="company_name"
                               placeholder="–û–û–û ¬´–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏¬ª"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="company_unp" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–£–ù–ü</label>
                        <input type="text" id="company_unp" name="company_unp"
                               placeholder="123456789"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="company_address" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                        <textarea id="company_address" name="company_address" rows="3"
                                  placeholder="–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                </fieldset>
                
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–î–æ—Å—Ç–∞–≤–∫–∞ *</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="delivery_method" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        <select id="delivery_method" name="delivery_method" required
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)</option>
                            <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É</option>
                            <option value="transport_company">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="delivery_address" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <textarea id="delivery_address" name="delivery_address" rows="3"
                                  placeholder="–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–µ—Å–ª–∏ –Ω–µ —Å–∞–º–æ–≤—ã–≤–æ–∑)"
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                        <small style="color: var(--secondary-gray);">–ü—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ –æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º</small>
                    </div>
                </fieldset>
                
                <fieldset style="border: none; padding: 0; margin-bottom: 2rem;">
                    <legend style="font-weight: bold; font-size: 1.1rem; color: var(--primary-red); margin-bottom: 1rem;">–û–ø–ª–∞—Ç–∞ *</legend>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="payment_method" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã *</label>
                        <select id="payment_method" name="payment_method" required
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç</option>
                            <option value="bank_transfer">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option>
                            <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                            <option value="invoice">–ü–æ —Å—á–µ—Ç—É (–¥–ª—è —é—Ä. –ª–∏—Ü)</option>
                        </select>
                    </div>
                </fieldset>
                
                <div style="margin-bottom: 2rem;">
                    <label for="notes" style="display: block; margin-bottom: 0.25rem; font-weight: 600;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                    <textarea id="notes" name="notes" rows="4"
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∫ –∑–∞–∫–∞–∑—É, –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ —Ç.–¥."
                              style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                    üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                </button>
            </form>
        </div>
        
        <!-- –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞ -->
        <div>
            <div style="position: sticky; top: 2rem;">
                <h2>–í–∞—à –∑–∞–∫–∞–∑</h2>
                <div style="background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem;">
                    {% for item in cart_items %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--light-gray);">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">{{ item.product.name }}</div>
                            <div style="font-size: 0.9rem; color: var(--secondary-gray);">
                                {{ item.product.price }} BYN √ó {{ item.quantity }}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: var(--primary-red);">
                            {{ item.get_total_price }} BYN
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div style="padding: 1rem 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>–¢–æ–≤–∞—Ä—ã ({{ cart.items_count }} –ø–æ–∑–∏—Ü–∏–π):</span>
                            <span style="font-weight: bold;">{{ cart.total_price }} BYN</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                            <span style="font-weight: bold; color: #28a745;">–£—Ç–æ—á–Ω—è–µ—Ç—Å—è</span>
                        </div>
                        
                        <hr style="margin: 1rem 0; border: 1px solid var(--light-gray);">
                        
                        <div style="display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: bold; color: var(--primary-red);">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span>{{ cart.total_price }} BYN</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e8f4fd; padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid var(--primary-red);">
                    <h3 style="color: var(--primary-red); margin-bottom: 1rem;">‚ÑπÔ∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--dark-gray);">
                        <li style="margin-bottom: 0.5rem;">–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</li>
                        <li style="margin-bottom: 0.5rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ</li>
                        <li style="margin-bottom: 0.5rem;">–°—Ä–æ–∫–∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —É—Ç–æ—á–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞</li>
                        <li>–í–æ–∑–º–æ–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–ª–∏ –±–µ–∑–Ω–∞–ª–∏—á–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 1rem;">
                    <h3 style="color: var(--primary-red); margin-bottom: 1rem;">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                    <div style="color: var(--dark-gray);">
                        <div style="margin-bottom: 0.5rem;"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +375 (232) 47-82-15</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Email:</strong> info@gzlin.by</div>
                        <div style="margin-bottom: 0.5rem;"><strong>–ê–¥—Ä–µ—Å:</strong> –≥. –ì–æ–º–µ–ª—å, —É–ª. –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è, 15</div>
                        <div style="font-size: 0.9rem; color: var(--secondary-gray);">–ü–Ω-–ü—Ç: 8:00-17:00, –°–±-–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
label {
    color: var(--dark-gray);
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary-red) !important;
    box-shadow: 0 0 0 3px rgba(203, 65, 59, 0.1);
}

input[required]:invalid {
    border-color: #dc3545;
}

input[required]:valid {
    border-color: #28a745;
}

fieldset {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
}

legend {
    padding: 0 0.5rem;
}

@media (max-width: 768px) {
    .container > div {
        grid-template-columns: 1fr !important;
        gap: 2rem !important;
    }
    
    .sticky-summary {
        position: static !important;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã */
.btn-primary:active {
    transform: scale(0.98);
}

.form-submitting {
    pointer-events: none;
    opacity: 0.7;
}
</style>

<script>
// –£–ª—É—á—à–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const deliveryMethod = document.getElementById('delivery_method');
    const deliveryAddress = document.getElementById('delivery_address');
    const paymentMethod = document.getElementById('payment_method');
    const companyFields = ['company_name', 'company_unp', 'company_address'];
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–º –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
    function toggleDeliveryAddress() {
        if (deliveryMethod.value === 'pickup') {
            deliveryAddress.disabled = true;
            deliveryAddress.style.background = '#f8f9fa';
            deliveryAddress.placeholder = '–ü—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ –∞–¥—Ä–µ—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è';
        } else {
            deliveryAddress.disabled = false;
            deliveryAddress.style.background = '';
            deliveryAddress.placeholder = '–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏';
        }
    }
    
    deliveryMethod.addEventListener('change', toggleDeliveryAddress);
    toggleDeliveryAddress(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    function toggleCompanyFields() {
        const isInvoice = paymentMethod.value === 'invoice';
        companyFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (isInvoice) {
                field.required = true;
                field.style.borderColor = '#ffc107';
            } else {
                field.required = false;
                field.style.borderColor = '';
            }
        });
    }
    
    paymentMethod.addEventListener('change', toggleCompanyFields);
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function() {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –û—Ñ–æ—Ä–º–ª—è–µ–º –∑–∞–∫–∞–∑...';
        form.classList.add('form-submitting');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ (–Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏)
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
            form.classList.remove('form-submitting');
        }, 10000);
    });
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneInput = document.getElementById('customer_phone');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('375')) {
            value = '+375 (' + value.slice(3, 5) + ') ' + value.slice(5, 8) + '-' + value.slice(8, 10) + '-' + value.slice(10, 12);
        }
        e.target.value = value;
    });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –£–ù–ü
    const unpInput = document.getElementById('company_unp');
    unpInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9);
    });
});
</script>
{% endblock %}